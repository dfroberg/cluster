apiVersion: batch/v1
kind: Job
metadata:
  generation: 1
  name: postgres-backup-restore-benji
  namespace: backup-system
spec:
  suspend: true
  completions: 1
  parallelism: 1
  backoffLimit: 1
  activeDeadlineSeconds: 100
  ttlSecondsAfterFinished: 100
  template:
    metadata:
      name: postgres-backup-restore-benji
    spec:
      containers:
      - image: postgres:12
        name: postgres-backup
        imagePullPolicy: IfNotPresent
        args:
          - -c
          - psql -U benji -h ${SECRET_POSTGRES_HOST} benji -f $(find /var/backups/benji/ -size +100k -maxdepth 1 -name "*.sql" -type f -exec stat -c "%y %n" {} + | sort -r | head -n1 | cut -d " " -f 4-)
          - && curl -fsS -m 10 --retry 5 -o /dev/null https://healthchecks.k8s.aml.ink/ping/73ec5213-d30b-4cc3-9ec2-1c2436ce0401
        command:
          - /bin/sh
        env:
        - name: PGPASSWORD
          value: ${SECRET_BENJI_POSTGRES_PASSWORD}
        
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /var/backups
          name: postgres-storage
      dnsPolicy: ClusterFirst
      restartPolicy: Never
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:
      - name: postgres-storage
        persistentVolumeClaim:
          claimName: backup-system-nfs-tank-share-pvc

