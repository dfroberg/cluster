---
- hosts:
    - master
    - worker
    - storage
  become: true
  gather_facts: false
  any_errors_fatal: false
  pre_tasks:
     - setup:
       register: setup_status
       until: setup_status is success
       delay: 10
       retries: 30
  roles:
    - ubuntu
  handlers:
    - name: restart sshd
      service:
        name: sshd
        state: restarted
      when: reboot_required.stat.exists == false

    - name: restart fail2ban
      service:
        name: fail2ban
        state: restarted
      when: reboot_required.stat.exists == false

    - name: restart systemd-resolved
      service:
        name: systemd-resolved
        state: restarted
      when: reboot_required.stat.exists == false

    - name: netplan apply
      command: netplan apply
      when: cfg_static_network == true